<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Estilos Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Iconos Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- CSS -->
    <link rel="stylesheet" th:href="@{/styles.css}">
    <!-- jQuery y Select2 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <title>Formulario Nacimiento</title>
    <style>
      @media (max-width: 991.98px) {
        .ejemplar-img {
          max-width: 60px !important;
          max-height: 60px !important;
        }
        .table th, .table td {
          padding: 0.3rem;
        }
        .campo-imagen {
          max-width: 90px;
        }
        .campo-precio,
        .campo-oferta {
          max-width: 80px;
        }
      }
      @media (min-width: 992px) {
        .ejemplar-img {
          max-width: 80px !important;
          max-height: 80px !important;
        }
        .campo-imagen {
          max-width: 120px;
        }
        .campo-precio,
        .campo-oferta {
          max-width: 100px;
        }
      }
      .option-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .rounded-4 {
        border-radius: 1.2rem !important;
      }
      .shadow-lg {
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15)!important;
      }
      .form-section {
        background: #f8f9fa;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
      }
      .ejemplares-section {
        background: #fff;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,.08)!important;
      }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="card shadow-lg border-0 rounded-4">
            <div class="card-body p-4">
                <h3 class="card-title text-center mb-4" th:text="${titulo}">Titulo</h3>
                <div th:if="${error}" class="alert alert-danger text-center" role="alert">
                    <span th:text="${error}"></span>
                </div>
                <form id="formNacimiento" th:action="@{${accion}}" th:object="${nacimientoDTO}" method="post" enctype="multipart/form-data">
                    <div class="row g-4">
                        <!-- Columna izquierda: Info de la Monta -->
                        <div class="col-12 col-lg-4">
                            <div class="form-section h-100">
                                <h5 class="text-secondary mb-3 text-center">üìù Informaci√≥n</h5>
                                <div class="mb-3">
                                    <label for="monta" class="form-label">Montas Disponibles<span class="text-danger">*</span></label>
                                    <select id="monta" class="form-select" th:field="*{monta.id}" required th:attr="disabled=${nacimientoDTO.id != null}">
                                        <option value="">Selecciona una monta</option>

                                        <!-- Mostrar solo la monta actual si el nacimiento ya existe -->
                                        <option th:if="${nacimientoDTO.id != null}" 
                                                th:value="${nacimientoDTO.monta.id}"
                                                th:data-img-macho="${nacimientoDTO.monta.macho.secureUrl}"
                                                th:data-img-hembra="${nacimientoDTO.monta.hembra.secureUrl}"
                                                th:text="${nacimientoDTO.monta.macho.nombre +' + '+nacimientoDTO.monta.hembra.nombre}"
                                                th:data-fecha="${#temporals.format(nacimientoDTO.monta.fechaMonta, 'dd/MMMM/yyyy')}">
                                        </option>

                                        <!-- Mostrar lista de montas solo si el nacimiento es nuevo -->
                                        <option th:if="${nacimientoDTO.id == null}"
                                                th:each="monta : ${listaMontas}"
                                                th:value="${monta.id}"
                                                th:data-img-macho="${monta.macho.secureUrl}"
                                                th:data-img-hembra="${monta.hembra.secureUrl}"
                                                th:text="${monta.macho.nombre +' + '+monta.hembra.nombre}"
                                                th:data-fecha="${#temporals.format(monta.fechaMonta, 'dd/MMMM/yyyy')}">
                                        </option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="fechaNacimiento" class="form-label fw-bold">Fecha Nacimiento<span class="text-danger">*</span></label>
                                    <input id="fechaNacimiento" class="form-control" type="date" th:field="*{fechaNacimiento}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="gazaposVivos" class="form-label fw-bold">Gazapos Vivos</label>
                                    <input id="gazaposVivos" class="form-control" type="number" th:field="*{gazaposVivos}" min="0" max="15">
                                </div>
                                <div class="mb-3">
                                    <label for="gazaposMuertos" class="form-label fw-bold">Gazapos Muertos</label>
                                    <input id="gazaposMuertos" class="form-control" type="number" th:field="*{gazaposMuertos}" min="0" max="15">
                                </div>
                                <div class="mb-3">
                                    <label for="nota" class="form-label">Nota</label>
                                    <textarea id="nota" class="form-control" th:field="*{nota}" rows="3" maxlength="500"></textarea>
                                </div>
                                <div class="d-grid mt-4">
                                    <button type="submit" class="btn btn-primary btn-lg rounded-3 shadow">Guardar Nacimiento</button>
                                </div>
                            </div>
                        </div>
                        <!-- Columna derecha: Ejemplares -->
                        <div class="col-12 col-lg-8">
                            <div class="ejemplares-section h-100">
                                <h5 class="text-secondary mb-3 text-center">üêá Ejemplares</h5>
                                <div class="table-responsive">
                                    <table class="table table-bordered align-middle mb-0">
                                        <thead>
                                            <tr class="text-center">
                                                <th scope="col">Imagen<span class="text-danger">*</span></th>
                                                <th scope="col">Sexo<span class="text-danger">*</span></th>
                                                <th scope="col">Precio<span class="text-danger">*</span></th>
                                                <th scope="col">Oferta</th>
                                                <th scope="col">Vendido</th>
                                                <th style="width: 50px;"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="ejemplaresContainer">
                                            <!-- Filas din√°micas aqu√≠ -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-3 text-end">
                                    <button type="button" class="btn btn-success" onclick="agregarEjemplar()">
                                        <i class="bi bi-plus-circle"></i> Agregar ejemplar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
    $(document).ready(function() {
        $('#monta').select2({
            templateResult: formatOption,
            templateSelection: formatOption,
            minimumResultsForSearch: -1
        });
        function formatOption(state) {
            if (!state.id) return state.text;
            const imgMacho = $(state.element).data('img-macho');
            const imgHembra = $(state.element).data('img-hembra');
            const fechaMonta = $(state.element).data('fecha');
            const name = state.text;

            return $(`
                <div class="option-wrapper">
                    <img src="${imgMacho}" class="img-select" title="Macho" />
                    <img src="${imgHembra}" class="img-select" title="Hembra" />
                    <span>&nbsp;&nbsp;${name}</span>
                    <span>&nbsp;&nbsp;(${fechaMonta})</span>
                </div>
            `);
        }
    });
    </script>
    <script th:inline="javascript">
        let ejemplares = /*[[${nacimientoDTO.ejemplares}]]*/ [];
    </script>
    <script th:src="@{/js/nacimiento-formulario.js}"></script>
    <div id="orientacion-aviso" class="alert alert-info text-center d-none" style="position:fixed;top:0;left:0;width:100%;z-index:9999;">
        Para mejor experiencia, gira tu dispositivo a modo horizontal y actualiza la p√°gina.
    </div>
    <script>
    function verificarOrientacion() {
        if(window.innerWidth < window.innerHeight){
            document.getElementById('orientacion-aviso').classList.remove('d-none');
        } else {
            document.getElementById('orientacion-aviso').classList.add('d-none');
        }
    }
    window.addEventListener('resize', verificarOrientacion);
    window.addEventListener('orientationchange', verificarOrientacion);
    window.addEventListener('DOMContentLoaded', verificarOrientacion);
    </script>
</body>
</html>